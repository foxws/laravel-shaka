<?php

declare(strict_types=1);

use Foxws\Shaka\Support\Filesystem\Media;
use Foxws\Shaka\Support\Filesystem\MediaCollection;
use Foxws\Shaka\Support\Packager\Packager;
use Foxws\Shaka\Support\Packager\Stream;

beforeEach(function () {
    // Mock media and disk setup
    $this->mockDisk = mock(\Foxws\Shaka\Support\Filesystem\Disk::class);
    $this->mockDisk->shouldReceive('isLocalDisk')->andReturn(true);
    $this->mockDisk->shouldReceive('path')->andReturn('/tmp/test.mp4');
});

it('validates empty media collection', function () {
    $packager = app(Packager::class);
    $emptyCollection = MediaCollection::make([]);

    $packager->open($emptyCollection);
})->throws(InvalidArgumentException::class, 'MediaCollection cannot be empty');

it('can open media collection with single media', function () {
    $packager = app(Packager::class);
    $media = mock(Media::class);

    $collection = MediaCollection::make([$media]);

    $result = $packager->open($collection);

    expect($result)->toBe($packager);
    expect($packager->getMediaCollection())->toBe($collection);
})->skip('Requires proper mocking setup');

it('can open media collection with multiple media', function () {
    $packager = app(Packager::class);
    $media1 = mock(Media::class);
    $media2 = mock(Media::class);

    $collection = MediaCollection::make([$media1, $media2]);

    $result = $packager->open($collection);

    expect($result)->toBe($packager);
    expect($packager->getMediaCollection()->count())->toBe(2);
})->skip('Requires proper mocking setup');

it('can generate streams from media collection', function () {
    $packager = app(Packager::class);

    $media1 = mock(Media::class);
    $media1->shouldReceive('getLocalPath')->andReturn('/tmp/video1.mp4');

    $media2 = mock(Media::class);
    $media2->shouldReceive('getLocalPath')->andReturn('/tmp/video2.mp4');

    $collection = MediaCollection::make([$media1, $media2]);

    $packager->open($collection);
    $streams = $packager->streams();

    // Should have 4 streams: 2 videos + 2 audios
    expect($streams)->toHaveCount(4);
    expect($streams->first())->toBeInstanceOf(Stream::class);
})->skip('Requires proper mocking setup');

it('stream can convert to command string', function () {
    $media = mock(Media::class);
    $media->shouldReceive('getLocalPath')->andReturn('/tmp/input.mp4');

    $stream = Stream::video($media)
        ->setOutput('output.mp4')
        ->addOption('bandwidth', '5000000');

    $commandString = $stream->toCommandString();

    expect($commandString)->toContain('in=/tmp/input.mp4');
    expect($commandString)->toContain('stream=video');
    expect($commandString)->toContain('output=output.mp4');
    expect($commandString)->toContain('bandwidth=5000000');
})->skip('Requires proper mocking setup');

it('stream can be created for video type', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media);

    expect($stream->getType())->toBe('video');
    expect($stream->getMedia())->toBe($media);
});

it('stream can be created for audio type', function () {
    $media = mock(Media::class);

    $stream = Stream::audio($media);

    expect($stream->getType())->toBe('audio');
    expect($stream->getMedia())->toBe($media);
});

it('stream can store and retrieve options', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media)
        ->addOption('key1', 'value1')
        ->addOption('key2', 'value2');

    expect($stream->getOptions())->toBe([
        'key1' => 'value1',
        'key2' => 'value2',
    ]);
});

it('stream can set multiple options at once', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media)
        ->setOptions([
            'bandwidth' => '5000000',
            'language' => 'en',
        ]);

    expect($stream->getOptions())->toBe([
        'bandwidth' => '5000000',
        'language' => 'en',
    ]);
});
