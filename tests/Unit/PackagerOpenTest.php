<?php

declare(strict_types=1);

use Foxws\Shaka\Filesystem\Media;
use Foxws\Shaka\Filesystem\MediaCollection;
use Foxws\Shaka\Support\Packager;
use Foxws\Shaka\Support\Stream;

it('validates empty media collection', function () {
    $packager = app(Packager::class);
    $emptyCollection = MediaCollection::make([]);

    $packager->open($emptyCollection);
})->throws(InvalidArgumentException::class, 'MediaCollection cannot be empty');

it('stream can be created for video type', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media);

    expect($stream->getType())->toBe('video');
    expect($stream->getMedia())->toBe($media);
});

it('stream can be created for audio type', function () {
    $media = mock(Media::class);

    $stream = Stream::audio($media);

    expect($stream->getType())->toBe('audio');
    expect($stream->getMedia())->toBe($media);
});

it('stream can store and retrieve options', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media)
        ->addOption('key1', 'value1')
        ->addOption('key2', 'value2');

    expect($stream->getOptions())->toBe([
        'key1' => 'value1',
        'key2' => 'value2',
    ]);
});

it('stream can set multiple options at once', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media)
        ->setOptions([
            'bandwidth' => '5000000',
            'language' => 'en',
        ]);

    expect($stream->getOptions())->toBe([
        'bandwidth' => '5000000',
        'language' => 'en',
    ]);
});

it('stream can chain method calls', function () {
    $media = mock(Media::class);

    $stream = Stream::video($media)
        ->addOption('bandwidth', '5000000')
        ->addOption('language', 'en')
        ->setOutput('output.mp4');

    expect($stream->getOptions())->toHaveKey('bandwidth');
    expect($stream->getOptions())->toHaveKey('language');
});

it('media collection can be created empty', function () {
    $collection = MediaCollection::make([]);

    expect($collection)->toBeInstanceOf(MediaCollection::class);
    expect($collection->isEmpty())->toBeTrue();
});

it('media collection can store media items', function () {
    $media1 = mock(Media::class);
    $media2 = mock(Media::class);

    $collection = MediaCollection::make([$media1, $media2]);

    expect($collection->count())->toBe(2);
    expect($collection->first())->toBe($media1);
});
